/*!
 gifken v0.0.2-alpha
 Copyright (c) 2015 aaharu
 This software is released under the MIT License.
 https://raw.github.com/aaharu/gifken/master/LICENSE

 This product includes following software:
 * jsgif
 - Copyright (c) 2011 Shachaf Ben-Kiki
 - https://github.com/shachaf/jsgif
 - https://raw.github.com/shachaf/jsgif/master/LICENSE
 * GifWriter.js
 - Copyright (c) 2013 NOBUOKA Yu
 - https://github.com/nobuoka/GifWriter.js
 - https://raw.github.com/nobuoka/GifWriter.js/master/LICENSE.txt
 */
function compressWithLZW(a,b){function c(){d=i+1,e=b+1,f=Object.create(null)}var d,e,f,g=new GifCompressedCodesToByteArrayConverter,h=1<<b,i=h+1;c(),g.push(h,e);for(var j="",k=0,l=a.length;l>k;++k){var m=a[k],n=String.fromCharCode(m);n in f||(f[n]=m);var o=j;j+=n,j in f||(g.push(f[o],e),4095>=d?(f[j]=d,d===1<<e&&e++,d++):(g.push(h,e),c(),f[n]=m),j=n)}return g.push(f[j],e),g.push(i,e),g.flush()}var gifken;!function(a){var b=function(){function a(a){this.frameIndex1=0,this.frameIndex2=0,this.frames=[],a||(this._version=0,this._width=1,this._height=1,this.colorResolution=112,this.sortFlag=!1,this.bgColorIndex=1,this.pixelAspectRatio=0,this.globalColorTable=d.createColorTable([new d(0,0,0),new d(255,255,255)]))}return a.parse=function(b){for(var c=new a(!0),d=new DataView(b),e=f.readHeader(c,d);;)if(e=f.readBlock(c,d,e),-1===e)break;return c},a.prototype.versionName=function(){return e[this._version]},Object.defineProperty(a.prototype,"version",{get:function(){return this._version},set:function(a){this._version=a},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"width",{get:function(){return this._width},set:function(a){if(a=~~a,a>65535||0>a)throw new RangeError("width range error: "+a);this._width=a},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"height",{get:function(){return this._height},set:function(a){if(a=~~a,a>65535||0>a)throw new RangeError("height range error: "+a);this._height=a},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalColorTable",{get:function(){return this._globalColorTable},set:function(a){this._globalColorTable=a,this._globalTableSize=a.byteLength/3,void 0===this.bgColorIndex&&(this.bgColorIndex=this._globalTableSize-1)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalTableSize",{get:function(){return this._globalTableSize},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"loopCount",{get:function(){return this._loopCount},set:function(a){if(a=~~a,a>65535||0>a)throw new RangeError("loopCount range error: "+a);this._loopCount=a},enumerable:!0,configurable:!0}),a.prototype.writeToArrayBuffer=function(){return a.writeToArrayBuffer(this)},a.writeToArrayBuffer=function(a){var b=[],c=new DataView(new ArrayBuffer(13));c.setUint8(0,71),c.setUint8(1,73),c.setUint8(2,70),c.setUint8(3,56),0===a.version?c.setUint8(4,57):c.setUint8(4,55),c.setUint8(5,97),c.setUint16(6,a.width,!0),c.setUint16(8,a.height,!0);var d=0,e=a.globalTableSize;if(e>0){d|=128;var f=0;do e>>=1,++f;while(e>1);d|=f-1}if(d|=a.colorResolution,a.sortFlag&&(d|=8),c.setUint8(10,d),c.setUint8(11,a.bgColorIndex),c.setUint8(12,a.pixelAspectRatio),b.push(new Uint8Array(c.buffer)),a.globalTableSize>0&&b.push(a.globalColorTable),a.isLoop){var g=new DataView(new ArrayBuffer(19));g.setUint8(0,33),g.setUint8(1,255),g.setUint8(2,11),g.setUint8(3,78),g.setUint8(4,69),g.setUint8(5,84),g.setUint8(6,83),g.setUint8(7,67),g.setUint8(8,65),g.setUint8(9,80),g.setUint8(10,69),g.setUint8(11,50),g.setUint8(12,46),g.setUint8(13,48),g.setUint8(14,3),g.setUint8(15,1),g.setUint16(16,a.loopCount,!0),g.setUint8(18,0),b.push(new Uint8Array(g.buffer))}return a.frames.forEach(function(a){var c=new DataView(new ArrayBuffer(18));if(c.setUint8(0,33),c.setUint8(1,249),c.setUint8(2,4),a.transparentFlag?c.setUint8(3,1):c.setUint8(3,0),c.setUint16(4,a.delayCentiSeconds,!0),c.setUint8(6,a.transparentColorIndex),c.setUint8(7,0),c.setUint8(8,44),c.setUint16(9,a.x,!0),c.setUint16(11,a.y,!0),c.setUint16(13,a.width,!0),c.setUint16(15,a.height,!0),a.localTableSize>0){var d=0,e=a.localTableSize;do e>>=1,++d;while(e>1);c.setUint8(17,128|d-1)}else c.setUint8(17,0);if(b.push(new Uint8Array(c.buffer)),a.localTableSize>0&&b.push(a.localColorTable),b.push(new Uint8Array([a.lzwCode])),void 0===a.compressedData&&void 0===a.pixelData)throw new Error("no image data");var f=0,g=a.compressedData;g=g instanceof Array?new Uint8Array(g):g||new Uint8Array(compressWithLZW(a.pixelData,a.lzwCode));for(var h=g.length;;){if(!(h>f+255)){var i=g.subarray(f);b.push(new Uint8Array([i.byteLength])),b.push(i);break}b.push(new Uint8Array([255])),b.push(g.subarray(f,f+255)),f+=255}b.push(new Uint8Array([0]))}),b.push(new Uint8Array([59])),b},a.prototype.writeToArray=function(){var b=a.writeToArrayBuffer(this),c=[];return b.forEach(function(a){for(var b=0,d=a.byteLength;d>b;++b)c.push(a[b])}),c},a.prototype.split=function(b){var c=this,d=[];return this.frames.forEach(b?function(b,e){var f=new a;if(f.version=c._version,f.width=c._width,f.height=c._height,f.colorResolution=c.colorResolution,f.sortFlag=c.sortFlag,f.bgColorIndex=c.bgColorIndex,f.pixelAspectRatio=c.pixelAspectRatio,f.globalColorTable=c._globalColorTable,0!==e&&b.transparentFlag){void 0===b.pixelData&&b.decompress(),void 0===c.frames[e-1].pixelData&&c.frames[e-1].decompress();for(var g=!1,h=0,i=b.pixelData.length;i>h;++h)b.pixelData[h]===b.transparentColorIndex&&(b.pixelData[h]=c.frames[e-1].pixelData[h],g=!0);if(g){var j=compressWithLZW(b.pixelData,b.lzwCode);b.compressedData=new Uint8Array(j)}delete b.pixelData}f.frames=[b],d.push(f)}:function(b){var e=new a;e.version=c._version,e.width=c._width,e.height=c._height,e.colorResolution=c.colorResolution,e.sortFlag=c.sortFlag,e.bgColorIndex=c.bgColorIndex,e.pixelAspectRatio=c.pixelAspectRatio,e.globalColorTable=c._globalColorTable,e.frames=[b],d.push(e)}),d},a.prototype.playback=function(b){var c=this,d=new a;return b&&this.frames.forEach(function(a,b){if(0!==b&&a.transparentFlag){void 0===a.pixelData&&a.decompress(),void 0===c.frames[b-1].pixelData&&c.frames[b-1].decompress();for(var d=!1,e=0,f=a.pixelData.length;f>e;++e)a.pixelData[e]===a.transparentColorIndex&&(a.pixelData[e]=c.frames[b-1].pixelData[e],d=!0);if(d){var g=compressWithLZW(a.pixelData,a.lzwCode);a.compressedData=new Uint8Array(g)}delete a.pixelData}}),d.version=this._version,d.width=this._width,d.height=this._height,d.colorResolution=this.colorResolution,d.sortFlag=this.sortFlag,d.bgColorIndex=this.bgColorIndex,d.pixelAspectRatio=this.pixelAspectRatio,d.globalColorTable=this._globalColorTable,d.frames=this.frames.reverse(),d.isLoop=this.isLoop,d.loopCount=this._loopCount,d},a}();a.Gif=b;var c=function(){function a(){}return a.init=function(b,c){var d=new a;return d.transparentFlag=!1,d.delayCentiSeconds=0,d.transparentColorIndex=0,d.x=0,d.y=0,d.width=b||1,d.height=c||1,d.localTableSize=0,d.lzwCode=4,d.pixelData=new Uint8Array(d.width*d.height),d},a.prototype.decompress=function(){this.pixelData=lzwDecode(this.lzwCode,this.compressedData,this.width*this.height)},a}();a.Frame=c;var d=function(){function a(a,b,c){this.r=a,this.g=b,this.b=c}return a.valueOf=function(){},a.createColorTable=function(b){for(var c=[],d=1;8>=d;++d)for(var e=(d<<1)-b.length,f=0;e>f;++f)b.push(new a(255,255,255));return b.forEach(function(a){c.push(a.r),c.push(a.g),c.push(a.b)}),new Uint8Array(c)},a}();a.Color=d,function(a){a[a.GIF89a=0]="GIF89a",a[a.GIF87a=1]="GIF87a"}(a.Version||(a.Version={}));var e=a.Version,f=function(){function a(){}return a.readHeader=function(a,b){a.version=e[String.fromCharCode(b.getUint8(0),b.getUint8(1),b.getUint8(2),b.getUint8(3),b.getUint8(4),b.getUint8(5))],a.width=b.getUint16(6,!0),a.height=b.getUint16(8,!0);var c,d=b.getUint8(10),f=128&d;return c=128!==f?0:1<<(7&d)+1,a.colorResolution=112&d,a.sortFlag=8===(8&d),a.bgColorIndex=b.getUint8(11),a.pixelAspectRatio=b.getUint8(12),128!==f?13:(a.globalColorTable=new Uint8Array(b.buffer,13,3*c),13+3*c)},a.readBlock=function(a,b,d){var e=b.getUint8(d);if(59===e)return-1;if(33===e){var f=b.getUint8(d+1);if(249===f)return void 0===a.frames[a.frameIndex1]?(g=new c,d=this.readGraphicControlExtensionBlock(g,b,d),a.frames.push(g)):(g=a.frames[a.frameIndex1],d=this.readGraphicControlExtensionBlock(g,b,d)),a.frameIndex1+=1,d;if(254===f)return d=this.readCommentExtensionBlock(a,b,d);if(255===f)return d=this.readApplicationExtensionBlock(a,b,d);if(1===f)return d=this.readPlainTextExtensionBlock(a,b,d)}if(44===e){var g;return void 0===a.frames[a.frameIndex2]?(g=new c,d=this.readImageBlock(g,b,d),a.frames.push(g)):(g=a.frames[a.frameIndex2],d=this.readImageBlock(g,b,d)),a.frameIndex2+=1,d}return-1},a.readImageBlock=function(a,b,c){a.x=b.getUint16(++c,!0),c+=2,a.y=b.getUint16(c,!0),c+=2,a.width=b.getUint16(c,!0),c+=2,a.height=b.getUint16(c,!0),c+=2;var d=b.getUint8(c++),e=128&d;128===e?(a.localTableSize=1<<(7&d)+1,a.localColorTable=new Uint8Array(b.buffer,c,3*a.localTableSize),c+=3*a.localTableSize):a.localTableSize=0,a.lzwCode=b.getUint8(c++);for(var f=new Array,g=0;;){var h=b.getUint8(c++);if(g+=h,0===h)break;f.push(new Uint8Array(b.buffer.slice(c,c+h))),c+=h}var i=new Uint8Array(g);i.set(f[0],0);for(var j=f[0].byteLength,k=1,l=f.length;l>k;++k)i.set(f[k],j),j+=f[k].byteLength;return a.compressedData=i,c},a.readApplicationExtensionBlock=function(a,b,c){if(c+=2,11!==b.getUint8(c++))throw new Error("faild: _readApplicationExtensionBlock");var d=String.fromCharCode(b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++));if("NETSCAPE2.0"===d){if(a.isLoop=!0,3!==b.getUint8(c++))throw new Error("faild: _readApplicationExtensionBlock (NETSCAPE2.0)");++c,a.loopCount=b.getUint16(c,!0),c+=2}for(;;){var e=b.getUint8(c++);if(0===e)break;c+=e}return c},a.readCommentExtensionBlock=function(a,b,c){for(c+=2;;){var d=b.getUint8(c++);if(0===d)break;c+=d}return c},a.readGraphicControlExtensionBlock=function(a,b,c){var d=b.getUint8(c+3);return a.transparentFlag=1===(1&d),a.delayCentiSeconds=b.getUint16(c+4,!0),a.transparentColorIndex=b.getUint8(c+6),c+8},a.readPlainTextExtensionBlock=function(a,b,c){for(c+=2;;){var d=b.getUint8(c++);if(0===d)break;c+=d}return c},a}()}(gifken||(gifken={}));var lzwDecode=function(a,b,c){for(var d,e,f=0,g=function(a){for(var c=0,d=0;a>d;++d)b[f>>3]&1<<(7&f)&&(c|=1<<d),++f;return c},h=new Uint8Array(c),i=1<<a,j=i+1,k=a+1,l=[],m=function(){l=[],k=a+1;for(var b=0;i>b;++b)l[b]=[b];l[i]=[],l[j]=null},n=0;;)if(e=d,d=g(k),d!==i){if(d===j)break;if(d<l.length)e!==i&&l.push(l[e].concat(l[d][0]));else{if(d!==l.length)throw new Error("Invalid LZW code.");l.push(l[e].concat(l[e][0]))}h.set(l[d],n),n+=l[d].length,l.length===1<<k&&12>k&&k++}else m();return h},GifCompressedCodesToByteArrayConverter=function(){function a(){this.__out=[],this.__remNumBits=0,this.__remVal=0}return a.prototype.push=function(a,b){for(;b>0;)this.__remVal=(a<<this.__remNumBits&255)+this.__remVal,b+this.__remNumBits>=8?(this.__out.push(this.__remVal),b-=8-this.__remNumBits,a>>=8-this.__remNumBits,this.__remVal=0,this.__remNumBits=0):(this.__remNumBits=b+this.__remNumBits,b=0)},a.prototype.flush=function(){this.push(0,8),this.__remNumBits=0,this.__remVal=0;var a=this.__out;return this.__out=[],a},a}();module.exports=gifken;