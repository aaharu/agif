/*!
gifken v0.0.1-alpha
Copyright (c) 2013 aaharu
This software is released under the MIT License.
https://raw.github.com/aaharu/gifken/master/LICENSE

This product includes following softwares:
* jsgif
- Copyright (c) 2011 Shachaf Ben-Kiki
- https://github.com/shachaf/jsgif
- https://raw.github.com/shachaf/jsgif/master/LICENSE
* GifWriter.js
- Copyright (c) 2013 NOBUOKA Yu
- https://github.com/nobuoka/GifWriter.js
- https://raw.github.com/nobuoka/GifWriter.js/master/LICENSE.txt
*/
var gifken;!function(a){function b(a,b){function c(){d=j+1,e=b+1,f=Object.create(null)}var d,e,f,g=new i,h=1<<b,j=h+1;c(),g.push(h,e);for(var k="",l=0,m=a.length;m>l;++l){var n=a[l],o=String.fromCharCode(n);o in f||(f[o]=n);var p=k;k+=o,k in f||(g.push(f[p],e),4095>=d?(f[k]=d,d===1<<e&&e++,d++):(g.push(h,e),c(),f[o]=n),k=o)}return g.push(f[k],e),g.push(j,e),g.flush()}var c=function(){function a(a){this.frameIndex1=0,this.frameIndex2=0,this.frames=[],a||(this._version=f.GIF89a,this._width=1,this._height=1,this.colorResolution=112,this.sortFlag=!1,this.bgColorIndex=1,this.pixelAspectRatio=0,this.globalColorTable=e.createColorTable([new e(0,0,0),new e(255,255,255)]))}return a.parse=function(b){for(var c=new a(!0),d=new DataView(b),e=g.readHeader(c,d);;)if(e=g.readBlock(c,d,e),-1===e)break;return c},a.prototype.versionName=function(){return f[this._version]},Object.defineProperty(a.prototype,"version",{get:function(){return this._version},set:function(a){this._version=a},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"width",{get:function(){return this._width},set:function(a){if(a=~~a,a>65535||0>a)throw new RangeError("width range error: "+a);this._width=a},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"height",{get:function(){return this._height},set:function(a){if(a=~~a,a>65535||0>a)throw new RangeError("height range error: "+a);this._height=a},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalColorTable",{get:function(){return this._globalColorTable},set:function(a){this._globalColorTable=a,this._globalTableSize=a.byteLength/3,void 0===this.bgColorIndex&&(this.bgColorIndex=this._globalTableSize-1)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalTableSize",{get:function(){return this._globalTableSize},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"loopCount",{get:function(){return this._loopCount},set:function(a){if(a=~~a,a>65535||0>a)throw new RangeError("loopCount range error: "+a);this._loopCount=a},enumerable:!0,configurable:!0}),a._writeToArrayBuffer=function(a){var c=[],d=new DataView(new ArrayBuffer(13));d.setUint8(0,71),d.setUint8(1,73),d.setUint8(2,70),d.setUint8(3,56),a.version===f.GIF89a?d.setUint8(4,57):d.setUint8(4,55),d.setUint8(5,97),d.setUint16(6,a.width,!0),d.setUint16(8,a.height,!0);var e=0,g=a.globalTableSize;if(g>0){e|=128;var h=0;do g>>=1,++h;while(g>1);e|=h-1}if(e|=a.colorResolution,a.sortFlag&&(e|=8),d.setUint8(10,e),d.setUint8(11,a.bgColorIndex),d.setUint8(12,a.pixelAspectRatio),c.push(new Uint8Array(d.buffer)),a.globalTableSize>0&&c.push(a.globalColorTable),a.isLoop){var i=new DataView(new ArrayBuffer(19));i.setUint8(0,33),i.setUint8(1,255),i.setUint8(2,11),i.setUint8(3,78),i.setUint8(4,69),i.setUint8(5,84),i.setUint8(6,83),i.setUint8(7,67),i.setUint8(8,65),i.setUint8(9,80),i.setUint8(10,69),i.setUint8(11,50),i.setUint8(12,46),i.setUint8(13,48),i.setUint8(14,3),i.setUint8(15,1),i.setUint16(16,a.loopCount,!0),i.setUint8(18,0),c.push(new Uint8Array(i.buffer))}return a.frames.forEach(function(a){var d=new DataView(new ArrayBuffer(18));if(d.setUint8(0,33),d.setUint8(1,249),d.setUint8(2,4),a.transparentFlag?d.setUint8(3,1):d.setUint8(3,0),d.setUint16(4,a.delayCentiSeconds,!0),d.setUint8(6,a.transparentColorIndex),d.setUint8(7,0),d.setUint8(8,44),d.setUint16(9,a.x,!0),d.setUint16(11,a.y,!0),d.setUint16(13,a.width,!0),d.setUint16(15,a.height,!0),a.localTableSize>0){var e=0,f=a.localTableSize;do f>>=1,++e;while(f>1);d.setUint8(17,128|e-1)}else d.setUint8(17,0);if(c.push(new Uint8Array(d.buffer)),a.localTableSize>0&&c.push(a.localColorTable),c.push(new Uint8Array([a.lzwCode])),void 0===a.compressedData&&void 0===a.pixelData)throw new Error("no image data");var g=0,h=a.compressedData;h=h instanceof Array?new Uint8Array(h):h||new Uint8Array(b(a.pixelData,a.lzwCode));for(var i=h.length;;){if(!(i>g+255)){var j=h.subarray(g);c.push(new Uint8Array([j.byteLength])),c.push(j);break}c.push(new Uint8Array([255])),c.push(h.subarray(g,g+255)),g+=255}c.push(new Uint8Array([0]))}),c.push(new Uint8Array([59])),c},a.prototype.writeToBlob=function(){return a.writeToBlob(this)},a.writeToBlob=function(b){return new Blob(a._writeToArrayBuffer(b),{type:"image/gif"})},a.prototype.writeToDataUrl=function(){return a.writeToDataUrl(this)},a.writeToDataUrl=function(b){var c=a._writeToArrayBuffer(b),d="";return c.forEach(function(a){for(var b=[],c=0,e=a.byteLength;e>c;++c)b.push(a[c]);d+=String.fromCharCode.apply(null,b)}),"data:image/gif;base64,"+btoa(d)},a.prototype.split=function(c){var d=this,e=[];return c?this.frames.forEach(function(c,f){var g=new a;if(g.version=d._version,g.width=d._width,g.height=d._height,g.colorResolution=d.colorResolution,g.sortFlag=d.sortFlag,g.bgColorIndex=d.bgColorIndex,g.pixelAspectRatio=d.pixelAspectRatio,g.globalColorTable=d._globalColorTable,0!==f&&c.transparentFlag){void 0===c.pixelData&&c.decompress(),void 0===d.frames[f-1].pixelData&&d.frames[f-1].decompress();for(var h=!1,i=0,j=c.pixelData.length;j>i;++i)c.pixelData[i]===c.transparentColorIndex&&(c.pixelData[i]=d.frames[f-1].pixelData[i],h=!0);if(h){var k=b(c.pixelData,c.lzwCode);c.compressedData=new Uint8Array(k)}delete c.pixelData}g.frames=[c],e.push(g)}):this.frames.forEach(function(b){var c=new a;c.version=d._version,c.width=d._width,c.height=d._height,c.colorResolution=d.colorResolution,c.sortFlag=d.sortFlag,c.bgColorIndex=d.bgColorIndex,c.pixelAspectRatio=d.pixelAspectRatio,c.globalColorTable=d._globalColorTable,c.frames=[b],e.push(c)}),e},a.prototype.playback=function(c){var d=this,e=new a;return c&&this.frames.forEach(function(a,c){if(0!==c&&a.transparentFlag){void 0===a.pixelData&&a.decompress(),void 0===d.frames[c-1].pixelData&&d.frames[c-1].decompress();for(var e=!1,f=0,g=a.pixelData.length;g>f;++f)a.pixelData[f]===a.transparentColorIndex&&(a.pixelData[f]=d.frames[c-1].pixelData[f],e=!0);if(e){var h=b(a.pixelData,a.lzwCode);a.compressedData=new Uint8Array(h)}delete a.pixelData}}),e.version=this._version,e.width=this._width,e.height=this._height,e.colorResolution=this.colorResolution,e.sortFlag=this.sortFlag,e.bgColorIndex=this.bgColorIndex,e.pixelAspectRatio=this.pixelAspectRatio,e.globalColorTable=this._globalColorTable,e.frames=this.frames.reverse(),e.isLoop=this.isLoop,e.loopCount=this._loopCount,e},a}();a.Gif=c;var d=function(){function a(){}return a.init=function(b){var c=new a(b);return c.transparentFlag=!1,c.delayCentiSeconds=0,c.transparentColorIndex=0,c.x=0,c.y=0,c.width=b.width||1,c.height=b.height||1,c.localTableSize=0,c.lzwCode=4,c.pixelData=new Uint8Array(c.width*c.height),c},a.prototype.decompress=function(){this.pixelData=h(this.lzwCode,this.compressedData,this.width*this.height)},a}();a.Frame=d;var e=function(){function a(a,b,c){this.r=a,this.g=b,this.b=c}return a.valueOf=function(){},a.createColorTable=function(b){for(var c=[],d=1;8>=d;++d)for(var e=(d<<1)-b.length,f=0;e>f;++f)b.push(new a(255,255,255));return b.forEach(function(a){c.push(a.r),c.push(a.g),c.push(a.b)}),new Uint8Array(c)},a}();a.Color=e,function(a){a[a.GIF89a=0]="GIF89a",a[a.GIF87a=1]="GIF87a"}(a.Version||(a.Version={}));var f=a.Version,g=function(){function a(){}return a.readHeader=function(a,b){a.version=f[String.fromCharCode(b.getUint8(0),b.getUint8(1),b.getUint8(2),b.getUint8(3),b.getUint8(4),b.getUint8(5))],a.width=b.getUint16(6,!0),a.height=b.getUint16(8,!0);var c,d=b.getUint8(10),e=128&d;return c=128!==e?0:1<<(7&d)+1,a.colorResolution=112&d,a.sortFlag=8===(8&d)?!0:!1,a.bgColorIndex=b.getUint8(11),a.pixelAspectRatio=b.getUint8(12),128!==e?13:(a.globalColorTable=new Uint8Array(b.buffer,13,3*c),13+3*c)},a.readBlock=function(a,b,c){var e=b.getUint8(c);if(59===e)return-1;if(33===e){var f=b.getUint8(c+1);if(249===f)return void 0===a.frames[a.frameIndex1]?(g=new d(a),c=this.readGraphicControlExtensionBlock(g,b,c),a.frames.push(g)):(g=a.frames[a.frameIndex1],c=this.readGraphicControlExtensionBlock(g,b,c)),a.frameIndex1+=1,c;if(254===f)return c=this.readCommentExtensionBlock(a,b,c);if(255===f)return c=this.readApplicationExtensionBlock(a,b,c);if(1===f)return c=this.readPlainTextExtensionBlock(a,b,c)}if(44===e){var g;return void 0===a.frames[a.frameIndex2]?(g=new d(a),c=this.readImageBlock(g,b,c),a.frames.push(g)):(g=a.frames[a.frameIndex2],c=this.readImageBlock(g,b,c)),a.frameIndex2+=1,c}return-1},a.readImageBlock=function(a,b,c){a.x=b.getUint16(++c,!0),c+=2,a.y=b.getUint16(c,!0),c+=2,a.width=b.getUint16(c,!0),c+=2,a.height=b.getUint16(c,!0),c+=2;var d=b.getUint8(c++),e=128&d;128===e?(a.localTableSize=1<<(7&d)+1,a.localColorTable=new Uint8Array(b.buffer,c,3*a.localTableSize),c+=3*a.localTableSize):a.localTableSize=0,a.lzwCode=b.getUint8(c++);for(var f=new Array,g=0;;){var h=b.getUint8(c++);if(g+=h,0===h)break;f.push(new Uint8Array(b.buffer.slice(c,c+h))),c+=h}var i=new Uint8Array(g);i.set(f[0],0);for(var j=f[0].byteLength,k=1,l=f.length;l>k;++k)i.set(f[k],j),j+=f[k].byteLength;return a.compressedData=i,c},a.readApplicationExtensionBlock=function(a,b,c){if(c+=2,11!==b.getUint8(c++))throw new Error("faild: _readApplicationExtensionBlock");var d=String.fromCharCode(b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++),b.getUint8(c++));if("NETSCAPE2.0"===d){if(a.isLoop=!0,3!==b.getUint8(c++))throw new Error("faild: _readApplicationExtensionBlock (NETSCAPE2.0)");++c,a.loopCount=b.getUint16(c,!0),c+=2}for(;;){var e=b.getUint8(c++);if(0===e)break;c+=e}return c},a.readCommentExtensionBlock=function(a,b,c){for(c+=2;;){var d=b.getUint8(c++);if(0===d)break;c+=d}return c},a.readGraphicControlExtensionBlock=function(a,b,c){var d=b.getUint8(c+3);return a.transparentFlag=1===(1&d),a.delayCentiSeconds=b.getUint16(c+4,!0),a.transparentColorIndex=b.getUint8(c+6),c+8},a.readPlainTextExtensionBlock=function(a,b,c){for(c+=2;;){var d=b.getUint8(c++);if(0===d)break;c+=d}return c},a}(),h=function(a,b,c){for(var d,e,f=0,g=function(a){for(var c=0,d=0;a>d;++d)b[f>>3]&1<<(7&f)&&(c|=1<<d),++f;return c},h=new Uint8Array(c),i=1<<a,j=i+1,k=a+1,l=[],m=function(){l=[],k=a+1;for(var b=0;i>b;++b)l[b]=[b];l[i]=[],l[j]=null},n=0;;)if(e=d,d=g(k),d!==i){if(d===j)break;if(d<l.length)e!==i&&l.push(l[e].concat(l[d][0]));else{if(d!==l.length)throw new Error("Invalid LZW code.");l.push(l[e].concat(l[e][0]))}h.set(l[d],n),n+=l[d].length,l.length===1<<k&&12>k&&k++}else m();return h},i=function(){function a(){this.__out=[],this.__remNumBits=0,this.__remVal=0}return a.prototype.push=function(a,b){for(;b>0;)this.__remVal=(255&a<<this.__remNumBits)+this.__remVal,b+this.__remNumBits>=8?(this.__out.push(this.__remVal),b-=8-this.__remNumBits,a>>=8-this.__remNumBits,this.__remVal=0,this.__remNumBits=0):(this.__remNumBits=b+this.__remNumBits,b=0)},a.prototype.flush=function(){this.push(0,8),this.__remNumBits=0,this.__remVal=0;var a=this.__out;return this.__out=[],a},a}()}(gifken||(gifken={}));